<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Team Timezone Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘¥</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) {
            :root { font-family: 'Inter var', sans-serif; }
        }
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #meeting-section,
        #empty-state {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen p-8 transition-colors duration-300">

    <header class="mb-8">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white text-center md:text-left">
                My Team
            </h1>
            <div class="flex items-center justify-center md:justify-end gap-3">
                <button type="button" id="restore-team-btn" class="relative bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors group">
                    Restore Team
                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-black text-white text-xs rounded-md p-2 opacity-0 group-hover:opacity-100 transition-opacity" role="tooltip">
                        Add any missing default team members
                    </span>
                </button>
                <button type="button" id="add-tile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    + Add Tile
                </button>
            </div>
        </div>
    </header>

    <main>
        <div id="empty-state" class="text-center text-gray-500 dark:text-gray-400 py-16">
            <h2 class="text-2xl font-semibold mb-4">Your Dashboard is Empty</h2>
            <p class="text-lg">Click the "+ Add Tile" button to add your first team member.</p>
        </div>
        <div id="tile-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
        <section id="meeting-section" class="mt-12 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-center gap-4 flex-wrap">
            <label for="meeting-time-input" class="text-lg font-medium">Team Time Converter:</label>
            <input type="time" id="meeting-time-input" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <button type="button" id="clear-meeting-time-btn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-bold py-2 px-3 rounded-lg text-lg leading-none" aria-label="Clear meeting time">&times;</button>
        </section>
    </main>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center p-4 hidden transition-opacity duration-300 opacity-0" aria-modal="true" role="dialog">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md transform scale-95 transition-all duration-300">
            <h3 id="modal-title" class="text-2xl font-semibold mb-6">Create New Tile</h3>
            <form id="tile-form">
                <input type="hidden" id="editing-tile-id">
                <div class="mb-4">
                    <label for="title-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title (Name)</label>
                    <input type="text" id="title-input" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="timezone-search-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Timezone</label>
                    <input type="text" id="timezone-search-input" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., London or New_York">
                </div>
                <div class="mb-6">
                    <label for="timezone-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Timezone</label>
                    <select id="timezone-select" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required size="8">
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Save Tile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tileGrid = document.getElementById('tile-grid');
            const addTileBtn = document.getElementById('add-tile-btn');
            const restoreTeamBtn = document.getElementById('restore-team-btn');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const cancelBtn = document.getElementById('cancel-btn');
            const tileForm = document.getElementById('tile-form');
            const titleInput = document.getElementById('title-input');
            const timezoneSelect = document.getElementById('timezone-select');
            const timezoneSearchInput = document.getElementById('timezone-search-input');
            const editingTileIdInput = document.getElementById('editing-tile-id');
            const meetingTimeInput = document.getElementById('meeting-time-input');
            const clearMeetingTimeBtn = document.getElementById('clear-meeting-time-btn');
            const meetingSection = document.getElementById('meeting-section');
            const emptyState = document.getElementById('empty-state');

            let tiles = [];
            const STORAGE_KEY_TILES = 'timezoneTiles';
            const allTimezones = Intl.supportedValuesOf('timeZone');
            const allTimezoneOptions = allTimezones.map(tz => {
                return { value: tz, text: tz.replace(/_/g, ' ') };
            });

            const DEFAULT_TILES = [
                { id: 1678886401, title: "Nigel", timezone: "Africa/Johannesburg" },
                { id: 1678886402, title: "Pedro", timezone: "Europe/Lisbon" },
                { id: 1678886403, title: "Timur", timezone: "Europe/Madrid" },
                { id: 1678886404, title: "Gianmarco", timezone: "Europe/London" },
                { id: 1678886405, title: "Rob", timezone: "Europe/London" },
                { id: 1678886406, title: "Mykha", timezone: "America/Los_Angeles" },
                { id: 1678886407, title: "TJ", timezone: "Africa/Johannesburg" },
                { id: 1678886408, title: "Mundi", timezone: "Africa/Nairobi" },
                { id: 1678886409, title: "Duncan", timezone: "Africa/Johannesburg" }
            ];

            function getFormattedTime(timezone, formatOptions) {
                try {
                    const options = formatOptions || {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    };
                    const time = new Date().toLocaleTimeString('en-GB', {
                        timeZone: timezone,
                        ...options
                    });
                    if (time.includes('Invalid')) return 'Error';
                    return time;
                } catch (e) {
                    return "Error";
                }
            }

            function getDayPhaseIcon(timezone) {
                try {
                    const hour = parseInt(getFormattedTime(timezone, { hour: '2-digit', hour12: false }), 10);
                    if (hour >= 9 && hour < 18) return 'ðŸ’»'; 
                    if (hour >= 7 && hour < 9) return 'ðŸŒ…';  
                    if (hour >= 18 && hour < 22) return 'ðŸŒ†'; 
                    return 'ðŸ˜´'; 
                } catch (e) {
                    return 'â“';
                }
            }

            function getOffsetMinutes(timezone) {
                try {
                    const offsetString = new Intl.DateTimeFormat('en', { 
                        timeZone: timezone, 
                        timeZoneName: 'longOffset' 
                    }).formatToParts(new Date()).find(p => p.type === 'timeZoneName')?.value;

                    if (!offsetString || !offsetString.includes('GMT')) return 0;
                    
                    const parts = offsetString.replace('GMT', '').split(':');
                    const hours = parseInt(parts[0], 10) || 0;
                    const minutes = parseInt(parts[1], 10) || 0;

                    return (hours * 60) + (minutes * Math.sign(hours || 1));
                } catch (e) {
                    return 0;
                }
            }

            function populateTimezoneDropdown(selectElement, timezones) {
                selectElement.innerHTML = '';
                timezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz.value;
                    option.textContent = tz.text;
                    selectElement.appendChild(option);
                });
            }

            function filterTimezoneOptions() {
                const searchTerm = timezoneSearchInput.value.toLowerCase().replace(/_/g, ' ');
                const filteredTimezones = allTimezoneOptions.filter(tz => {
                    return tz.text.toLowerCase().includes(searchTerm);
                });
                populateTimezoneDropdown(timezoneSelect, filteredTimezones);
            }

            function renderTile(tile) {
                const tileEl = document.createElement('div');
                tileEl.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center relative min-h-[190px] transition-all transform hover:scale-105';
                tileEl.dataset.id = tile.id;
                tileEl.dataset.timezone = tile.timezone;

                const titleEl = document.createElement('h3');
                titleEl.className = 'text-xl font-semibold text-center';
                titleEl.textContent = tile.title;

                const timezoneEl = document.createElement('p');
                timezoneEl.className = 'text-sm text-gray-500 dark:text-gray-400 mb-2';
                timezoneEl.textContent = tile.timezone.replace(/_/g, ' ');

                const clockWrapper = document.createElement('div');
                clockWrapper.className = 'flex items-center gap-3';

                const clockEl = document.createElement('p');
                clockEl.className = 'text-5xl font-bold text-blue-600 dark:text-blue-400';
                clockEl.innerHTML = '<span class="loader"></span>';

                const phaseIconEl = document.createElement('span');
                phaseIconEl.className = 'text-3xl';
                phaseIconEl.title = 'Current activity';
                phaseIconEl.textContent = getDayPhaseIcon(tile.timezone);

                clockWrapper.appendChild(clockEl);
                clockWrapper.appendChild(phaseIconEl);

                const meetingTimeEl = document.createElement('p');
                meetingTimeEl.className = 'text-lg font-medium text-green-500 dark:text-green-400 mt-2 h-6';

                const deleteBtn = document.createElement('button');
                // Use a reliable SVG for the "X" icon instead of &times;
                deleteBtn.className = 'absolute top-3 right-3 text-gray-400 hover:text-red-500 p-1 transition-colors rounded-full';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>`;
                deleteBtn.setAttribute('aria-label', `Delete ${tile.title} tile`);
                deleteBtn.onclick = () => deleteTile(tile.id);

                const editBtn = document.createElement('button');
                editBtn.className = 'absolute bottom-3 right-3 text-gray-400 hover:text-blue-500 text-lg p-1 transition-colors';
                editBtn.innerHTML = '&#9998;';
                editBtn.setAttribute('aria-label', `Edit ${tile.title} tile`);
                editBtn.onclick = () => showEditModal(tile);

                tileEl.appendChild(deleteBtn);
                tileEl.appendChild(titleEl);
                tileEl.appendChild(timezoneEl);
                tileEl.appendChild(clockWrapper);
                tileEl.appendChild(meetingTimeEl);
                tileEl.appendChild(editBtn);
                tileGrid.appendChild(tileEl);

                updateTileClock(tileEl, tile.timezone);
                updateTileMeetingTime(tileEl, tile.timezone);
            }

            function updateTileClock(tileEl, timezone) {
                const clockEl = tileEl.querySelector('.text-5xl');
                const phaseIconEl = tileEl.querySelector('.text-3xl');
                if (clockEl) {
                    clockEl.textContent = getFormattedTime(timezone);
                }
                if(phaseIconEl) {
                    phaseIconEl.textContent = getDayPhaseIcon(timezone);
                }
            }

            function saveTilesToStorage() {
                localStorage.setItem(STORAGE_KEY_TILES, JSON.stringify(tiles));
            }

            function loadTilesFromStorage() {
                const savedTiles = localStorage.getItem(STORAGE_KEY_TILES);
                if (savedTiles) {
                    tiles = JSON.parse(savedTiles);
                } else {
                    tiles = [...DEFAULT_TILES];
                    saveTilesToStorage();
                }
            }

    function renderAllTiles() {
        tileGrid.innerHTML = '';
        const sortedTiles = [...tiles]
            .map(tile => ({
                ...tile,
                offset: getOffsetMinutes(tile.timezone)
            }))
            .sort((a, b) => a.offset - b.offset);
        
        sortedTiles.forEach(renderTile);
        checkDashboardState();
    }

    function checkDashboardState() {
        if (tiles.length === 0) {
            emptyState.style.display = 'block';
            meetingSection.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            meetingSection.style.display = 'flex';
        }
    }

    function showModal() {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
        }, 10);
    }

    function showEditModal(tile) {
        modalTitle.textContent = "Edit Tile";
        titleInput.value = tile.title;
        timezoneSearchInput.value = '';
        filterTimezoneOptions();
        timezoneSelect.value = tile.timezone;
        editingTileIdInput.value = tile.id;
        showModal();
    }

    function hideModal() {
        modal.classList.add('opacity-0');
        modal.querySelector('div').classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            tileForm.reset();
            editingTileIdInput.value = '';
        }, 300);
    }

    function handleSaveTile(e) {
        e.preventDefault();
        const title = titleInput.value.trim();
        const timezone = timezoneSelect.value;
        const editingId = editingTileIdInput.value;

        if (!title || !timezone) {
            alert('Please fill out all fields.');
            return;
        }

        if (editingId) {
            const tileIndex = tiles.findIndex(t => t.id == editingId);
            if (tileIndex > -1) {
                tiles[tileIndex].title = title;
                tiles[tileIndex].timezone = timezone;
            }
        } else {
            const newTile = {
                id: Date.now(),
                title: title,
                timezone: timezone
            };
            tiles.push(newTile);
        }
        
        saveTilesToStorage();
        renderAllTiles();
        hideModal();
    }

    function deleteTile(id) {
        tiles = tiles.filter(tile => tile.id !== id);
        saveTilesToStorage();
        renderAllTiles();
    }

    function restoreDefaultTiles() {
        const existingTitlesAndZones = new Set(tiles.map(t => `${t.title.toLowerCase()}|${t.timezone}`));
        let tilesAdded = false;
        DEFAULT_TILES.forEach(defaultTile => {
            const checkKey = `${defaultTile.title.toLowerCase()}|${defaultTile.timezone}`;
            if (!existingTitlesAndZones.has(checkKey)) {
                tiles.push({ ...defaultTile, id: Date.now() + Math.random() });
                tilesAdded = true;
            }
        });
        
        if (tilesAdded) {
            saveTilesToStorage();
            renderAllTiles();
        }
    }

    function updateAllTileClocks() {
        document.querySelectorAll('#tile-grid > div').forEach(tileEl => {
            const timezone = tileEl.dataset.timezone;
            if (timezone) {
                updateTileClock(tileEl, timezone);
            }
        });
    }

    function handleMeetingTimeChange() {
        document.querySelectorAll('#tile-grid > div').forEach(tileEl => {
            const timezone = tileEl.dataset.timezone;
            if (timezone) {
                updateTileMeetingTime(tileEl, timezone);
            }
        });
    }
    
    function updateTileMeetingTime(tileEl, tileTimezone) {
        const meetingTimeEl = tileEl.querySelector('.text-lg');
        const localTimeInput = meetingTimeInput.value;
        
        if (!localTimeInput) {
            meetingTimeEl.textContent = '';
            return;
        }
        
        const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        try {
            const [hours, minutes] = localTimeInput.split(':');
            const sourceDateStr = new Date().toLocaleDateString('en-CA', {timeZone: localTimezone});
            const sourceDateTimeStr = `${sourceDateStr}T${localTimeInput}:00`;
            const sourceDate = new Date(sourceDateTimeStr);
            
            const formattedTime = sourceDate.toLocaleTimeString('en-GB', {
                timeZone: tileTimezone,
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            const targetDateStr = sourceDate.toLocaleDateString('en-CA', {timeZone: tileTimezone});
            
            let dayIndicator = "";
            if (targetDateStr > sourceDateStr) {
                dayIndicator = " (+1d)";
            } else if (targetDateStr < sourceDateStr) {
                dayIndicator = " (-1d)";
            }
            
            meetingTimeEl.textContent = `${formattedTime}${dayIndicator}`;

        } catch (e) {
            console.error("Error calculating meeting time:", e);
            meetingTimeEl.textContent = 'Error';
        }
    }

    function init() {
        populateTimezoneDropdown(timezoneSelect, allTimezoneOptions);
        
        loadTilesFromStorage();
        renderAllTiles();

        setInterval(updateAllTileClocks, 1000 * 30);

        addTileBtn.addEventListener('click', () => {
            modalTitle.textContent = "Create New Tile";
            editingTileIdInput.value = '';
            tileForm.reset();
            filterTimezoneOptions();
            showModal();
        });
        restoreTeamBtn.addEventListener('click', restoreDefaultTiles);
        cancelBtn.addEventListener('click', hideModal);
        tileForm.addEventListener('submit', handleSaveTile);
        timezoneSearchInput.addEventListener('input', filterTimezoneOptions);
        meetingTimeInput.addEventListener('input', handleMeetingTimeChange);
        clearMeetingTimeBtn.addEventListener('click', () => {
            meetingTimeInput.value = '';
            handleMeetingTimeChange();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });
    }

    init();
});
</script>
</body>
</html>
